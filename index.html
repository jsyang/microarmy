<html><style> canvas{position:absolute;left:0;top:0;} </style>
<script src=helper.js></script>

<script src=gamestat.js></script>
<script src=maps.js></script>
<script src=gLayer.js></script>
<script src=sLayer.js></script>

<script src=enum.js></script>
<script src=entity_base.js></script>
<script src=entity_structure.js></script>
<script src=entity_infantry.js></script>
<script src=entity_projectile.js></script>
<script src=entity_specialfx.js></script>

<body></body>
<script>

// Special Entities ///////////////////////////////////////////////////////////

var stats=new (function()
{
  this.log=[];
  for(var i=12;i--;) this.log.push("");
})();    

/*
    Audio channels (HTML5 only!)
    At least one channel for each sound, multiple channels for more frequent sounds.
    Groups: gunfire, death sounds, explosions and specials, music, gamestate sounds
    
    These are fully defined within world.loadResources()
*/
var audio;
var music;

var world=new (function()
{
  this.w=2490;
  this.h=192;    
  
  // Drawing contexts.
  this.BG=undefined;
  this.FG=undefined;
  this.FGimgs=undefined;
  
  // Terrain heightmap.
  this.heightmap=[];    
  
  // Hash array contains partitions (shWidth 64 (1<<6) pixels) of the gamefield    
  this.shWidth=6;
  this.newSpatialHash=function()
  {
    var newSH=[];
    for(var i=(this.w>>this.shWidth)+1; i--;) newSH.push([]);
    return newSH;
  };
  this.spatialHash=this.newSpatialHash();
  
  // Entity lists: STUFF that's alive
  this.infantry=[];
  this.vehicles=[];
  this.aircraft=[];
  this.projectiles=[];
  this.explosions=[];
  this.structures=[];
  
  this.loadResources=function()
  // Load the graphics and audio; setup things related to resources
  {
    // Fill the heightmap and draw the background -- "props"
    var g_BG=new gLayer(map,[world.w,world.h],function(g)
    {
      var w=g.w, h=g.h;
      g.c.drawImage(g.i[0],0,0);
      var d=g.c.getImageData(0,0,w,h).data;      
      for(var x=w;x--;)
      {
        for(var y=h-1; d[(y*w+x)*4+3];) y--;
        world.heightmap.push(y);
      }
      world.heightmap.reverse();
      g.c.drawImage(g.i[1],0,0);
      g.c.drawImage(g.i[0],0,0);        
      world.BG=g.c;
    });
    
    var g_FG=new gLayer([
  
      // Special Effects
      "gfx/fire0.png",
      "gfx/exp1.png",
      
      // Units
      "gfx/pistol0.png", "gfx/rocket0.png",
      "gfx/pistol1.png", "gfx/rocket1.png",
      
      // Structures
      "gfx/commcenter0.png","gfx/commcenter1.png"
      
      // Todo: Vehicles
      // Todo: Aircraft
      // Todo: Debris particles
      
    ],[world.w,world.h],function(g)
    {
      world.FG=g.c;
      world.FGimgs=g.i;
    });
    
    audio=new sLayer(
    {
      pistol:{    src:"snd/pistol",   channels:5  },
      rocket:{    src:"snd/rocket",   channels:5  },
      
      die1:{      src:"snd/die1",     channels:6  },
      die2:{      src:"snd/die2",     channels:6  },
      die3:{      src:"snd/die3",     channels:6  },
      die4:{      src:"snd/die4",     channels:6  },
      
      expsmall:{  src:"snd/expsmall", channels:6  },
      accomp:{    src:"snd/accomp",   channels:1  }
      
    });
  };
  
  this.run=function()
  // Do a bunch of stuff at once: blit, process game events
  // Maybe separate this later? Doesn't make sense to do it right now.
  {        
    var FG=world.FG;
    var FGimgs=world.FGimgs;
    world.FG.clearRect(0,0,world.w,world.h);
    // Viewport coords
    var vw=window.innerWidth;
    var vs=document.body.scrollLeft;
    
    var newSpatialHash=this.newSpatialHash();

    // Handle Infantry
    var newInfantry=[];
    for(var i in world.infantry)
    {
      var a=world.infantry[i];
      
      if(a.x>vs && a.x<vs+vw) // cull out-of-scene entities
      FG.drawImage(FGimgs[a.GFXSET],a.frame*8,a.action*8,8,8,a.x-3,a.y-7,8,8);
      
      a.active();
      if(a.health>0)      newSpatialHash[a.x>>world.shWidth].push(a);
      if(a.corpseTime)    newInfantry.push(a);
      //else log.unitRot();   // or .unitRust() for vehicles
    }
    world.infantry=newInfantry;
    
    // Handle Projectile
    var newProjectiles=[];
    for(var i in world.projectiles)
    {
      var a=world.projectiles[i];
      
      if(a.x>vs && a.x<vs+vw) // cull out-of-scene entities
      FG.drawImage(FGimgs[Enum.GFX.PROJECTILES],(a.dx<0)?0:3,a.type*3,3,3,a.x-2,a.y-2,3,3);
      
      a.fly();
      if(a.range) newProjectiles.push(a);
    }
    world.projectiles=newProjectiles;        
    
    // Handle Explosions
    var newExplosions=[];
    for(var i in world.explosions)
    {
      var a=world.explosions[i];            
      var f=a.frame;            
      var w=a.width;
      var h=a.height;            
      
      if(a.x>vs && a.x<vs+vw) // cull out-of-scene entities
      FG.drawImage(FGimgs[Enum.GFX.EXPLOSION1],f*w,0,w,h,a.x-(w>>1),a.y-(h>>1),w,h);
      
      a.explode();
      if(a.frame>a.lastFrame) continue;            
      newExplosions.push(a);
    }
    world.explosions=newExplosions;
    
    // Reset the spatialHash for the next cycle!
    world.spatialHash=newSpatialHash;
  };
  
})();    
    

////////////////////////////////////////////////////////////////////////////////    
// Throwaway events and other testing stuff beyond this point! /////////////////
////////////////////////////////////////////////////////////////////////////////
    
function makeInfantry(team) {
  var t=(!RAND(0,18))? "rocket":"pistol";
  if(team==0) world.infantry.push(new Infantry(20,0,0,t));
  else world.infantry.push(new Infantry(2420,0,1,t));
  setTimeout("makeInfantry("+team+")",RAND(200,10200));
};
    
window.onload=function()
{
  world.loadResources();
  setInterval("world.run()",40);
  makeInfantry(Enum.Team.GREEN);
  makeInfantry(Enum.Team.BLUE);    
};

window.onclick=function(e){ world.explosions.push(new SmallExplosion(e.pageX,e.pageY)); };
</script></html>

